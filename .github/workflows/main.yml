name: CI

on:
  push:
    branches:
      - "master"
  pull_request:
    branches:
      - "*"
concurrency:
  # Cancel any previous workflows if they are from a PR or push.
  group: ${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

defaults:
  run:
    shell: bash

env:
  # go needs absolute directories, using the $HOME variable doesn't work here.
  GOCACHE: /home/runner/work/go/pkg/build
  GOPATH: /home/runner/work/go
  GOBIN: /home/runner/work/go/bin
  GO111MODULE: on

  # If you change this please run `make lint` to see where else it needs to be
  # updated as well.
  GO_VERSION: 1.24.6

  BITCOIND_VERSION: '22.0'
  BITCOIND_IMAGE: 'lightninglabs/bitcoin-core'

  BTCD_VERSION_LATEST: v0.25.0

jobs:
  ########################
  # Format, compileation and lint check
  ########################
  lint-check:
    name: Format, compilation and lint check
    runs-on: ubuntu-latest
    steps:
      - name: git checkout
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Clean up runner space
        uses: ./.github/actions/cleanup-space

      - name: setup go ${{ env.GO_VERSION }}
        uses: actions/setup-go@v5
        with:
          go-version: '${{ env.GO_VERSION }}'

      - name: Check default values in sample-btcwallet.conf file
        run: make sample-conf-check

      - name: Check code format
        run: make fmt-check

      - name: Check go modules tidiness
        run: make tidy-module-check

      - name: Check RPC format
        run: make rpc-check

      - name: Check generated SQL code is up-to-date
        run: make sqlc-check

      - name: Check SQL formatting
        run: make sql-format-check

      - name: Check SQL linting
        run: make sql-lint-check

      - name: compile code
        run: go install -v ./...

      - name: Lint proto files
        run: make protolint

      - name: run lint
        run: make lint-check

  check-commits:
    if: github.event_name == 'pull_request'
    name: Check commits
    runs-on: ubuntu-latest
    steps:
      - name: git checkout
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Clean up runner space
        uses: ./.github/actions/cleanup-space

      - name: setup go ${{ env.GO_VERSION }}
        uses: actions/setup-go@v5
        with:
          go-version: '${{ env.GO_VERSION }}'

      - name: fetch and rebase on ${{ github.base_ref }}
        uses: ./.github/actions/rebase

      - name: check commits
        run: scripts/check-each-commit.sh upstream/${{ github.base_ref }}

  ########################
  # run unit tests
  ########################
  unit-test:
    name: run unit tests
    runs-on: ubuntu-latest
    strategy:
      # Allow other tests in the matrix to continue if one fails.
      fail-fast: false
      matrix:
        unit_type:
          - unit-race
          - unit-cover
    steps:
      - name: extract bitcoind from docker image
        run: |-
          docker pull ${{ env.BITCOIND_IMAGE }}:${{ env.BITCOIND_VERSION }}
          CONTAINER_ID=$(docker create ${{ env.BITCOIND_IMAGE }}:${{ env.BITCOIND_VERSION }})
          sudo docker cp $CONTAINER_ID:/opt/bitcoin-${{ env.BITCOIND_VERSION }}/bin/bitcoind /usr/local/bin/bitcoind
          docker rm $CONTAINER_ID

      - name: git checkout
        uses: actions/checkout@v5

      - name: Clean up runner space
        uses: ./.github/actions/cleanup-space

      - name: go cache
        uses: actions/cache@v4
        with:
          path: /home/runner/work/go
          key: btcwallet-${{ runner.os }}-go-${{ env.GO_VERSION }}-${{ github.job }}-${{ hashFiles('**/go.sum') }}
          restore-keys: |
            btcwallet-${{ runner.os }}-go-${{ env.GO_VERSION }}-${{ github.job }}-${{ hashFiles('**/go.sum') }}
            btcwallet-${{ runner.os }}-go-${{ env.GO_VERSION }}-${{ github.job }}-
            btcwallet-${{ runner.os }}-go-${{ env.GO_VERSION }}-
            btcwallet-${{ runner.os }}-go-

      - name: setup go ${{ env.GO_VERSION }}
        uses: actions/setup-go@v5
        with:
          go-version: '${{ env.GO_VERSION }}'

      - name: run ${{ matrix.unit_type }}
        run: make ${{ matrix.unit_type }}

      - name: Send coverage
        uses: coverallsapp/github-action@v2
        if: matrix.unit_type == 'unit-cover'
        continue-on-error: true
        with:
          file: coverage.txt
          flag-name: unit
          format: golang
          parallel: true

  ########################
  # run integration tests (SQLite + Postgres)
  ########################
  itest-db:
    name: integration tests (${{ matrix.db }}, ${{ matrix.race && 'race' || 'cover' }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        db: [sqlite, postgres]
        race: [false, true]
    steps:
      - name: git checkout
        uses: actions/checkout@v5

      - name: Clean up runner space
        uses: ./.github/actions/cleanup-space

      - name: go cache
        uses: actions/cache@v4
        with:
          path: /home/runner/work/go
          key: btcwallet-${{ runner.os }}-go-${{ env.GO_VERSION }}-${{ github.job }}-${{ hashFiles('**/go.sum') }}
          restore-keys: |
            btcwallet-${{ runner.os }}-go-${{ env.GO_VERSION }}-${{ github.job }}-${{ hashFiles('**/go.sum') }}
            btcwallet-${{ runner.os }}-go-${{ env.GO_VERSION }}-${{ github.job }}-
            btcwallet-${{ runner.os }}-go-${{ env.GO_VERSION }}-
            btcwallet-${{ runner.os }}-go-

      - name: setup go ${{ env.GO_VERSION }}
        uses: actions/setup-go@v5
        with:
          go-version: '${{ env.GO_VERSION }}'

      - name: run ${{ matrix.db }} itest-db (coverage)
        if: ${{ !matrix.race }}
        run: make itest-db db=${{ matrix.db }} cover=1 verbose=1

      - name: run ${{ matrix.db }} itest-db-race
        if: matrix.race
        run: make itest-db-race db=${{ matrix.db }} verbose=1

      - name: Upload coverage to Coveralls
        uses: coverallsapp/github-action@v2
        if: ${{ !matrix.race }}
        continue-on-error: true
        with:
          file: coverage-itest-${{ matrix.db }}.txt
          flag-name: itest-db-${{ matrix.db }}
          format: golang
          parallel: true

  ########################
  # Run bwtest integration tests against each supported chain backend.
  #
  # These jobs currently use kvdb only. Database expansion is planned via a
  # separate matrix in a future change.
  ########################
  itest-btcd:
    name: itest btcd
    runs-on: ubuntu-latest
    steps:
      - name: git checkout
        uses: actions/checkout@v5

      - name: Clean up runner space
        uses: ./.github/actions/cleanup-space

      - name: setup go ${{ env.GO_VERSION }}
        uses: actions/setup-go@v5
        with:
          go-version: '${{ env.GO_VERSION }}'

      - name: add go bin to PATH
        run: echo "$(go env GOPATH)/bin" >> $GITHUB_PATH

      - name: install btcd ${{ env.BTCD_VERSION_LATEST }}
        run: go install -v github.com/btcsuite/btcd@${{ env.BTCD_VERSION_LATEST }}

      - name: check btcd version
        run: btcd --version

      # The btcd backend job runs btcd for both the shared miner and the chain
      # backend under test.
      - name: run itest (btcd, kvdb)
        run: make itest chain=btcd db=kvdb

      - name: upload itest logs
        if: ${{ failure() }}
        uses: actions/upload-artifact@v4
        with:
          name: itest-logs-btcd
          path: itest/test-logs
          retention-days: 5

  ########################
  # Run bwtest integration tests with the neutrino backend.
  #
  # Job flow:
  # - Install btcd `${{ env.BTCD_VERSION_LATEST }}`.
  # - Use btcd as the shared miner for the suite.
  # - Run `make itest chain=neutrino db=kvdb` so wallets use the in-process
  #   neutrino backend while blocks/peers come from btcd.
  ########################
  itest-neutrino:
    name: itest neutrino
    runs-on: ubuntu-latest
    steps:
      - name: git checkout
        uses: actions/checkout@v5

      - name: Clean up runner space
        uses: ./.github/actions/cleanup-space

      - name: setup go ${{ env.GO_VERSION }}
        uses: actions/setup-go@v5
        with:
          go-version: '${{ env.GO_VERSION }}'

      - name: add go bin to PATH
        run: echo "$(go env GOPATH)/bin" >> $GITHUB_PATH

      - name: install btcd ${{ env.BTCD_VERSION_LATEST }}
        run: go install -v github.com/btcsuite/btcd@${{ env.BTCD_VERSION_LATEST }}

      - name: check btcd version
        run: btcd --version

      # Neutrino runs in-process, but it still relies on the shared btcd miner
      # for chain data and peer connectivity.
      - name: run itest (neutrino, kvdb)
        run: make itest chain=neutrino db=kvdb

      - name: upload itest logs
        if: ${{ failure() }}
        uses: actions/upload-artifact@v4
        with:
          name: itest-logs-neutrino
          path: itest/test-logs
          retention-days: 5

  ########################
  # Run bwtest integration tests with the bitcoind backend.
  #
  # Job flow:
  # - Install btcd `${{ env.BTCD_VERSION_LATEST }}` as the shared miner.
  # - Run a matrix over bitcoind versions `30` (latest) and `28` (older).
  # - Extract each matrix binary from the docker image and run
  #   `make itest chain=bitcoind db=kvdb`.
  ########################
  itest-bitcoind:
    name: itest bitcoind (v${{ matrix.bitcoind_version }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        bitcoind_version: ['30', '28']
    steps:
      - name: git checkout
        uses: actions/checkout@v5

      - name: Clean up runner space
        uses: ./.github/actions/cleanup-space

      - name: go cache
        uses: actions/cache@v4
        with:
          path: /home/runner/work/go
          key: btcwallet-${{ runner.os }}-go-${{ env.GO_VERSION }}-${{ github.job }}-${{ matrix.bitcoind_version }}-${{ hashFiles('**/go.sum') }}
          restore-keys: |
            btcwallet-${{ runner.os }}-go-${{ env.GO_VERSION }}-${{ github.job }}-${{ matrix.bitcoind_version }}-${{ hashFiles('**/go.sum') }}
            btcwallet-${{ runner.os }}-go-${{ env.GO_VERSION }}-${{ github.job }}-${{ matrix.bitcoind_version }}-
            btcwallet-${{ runner.os }}-go-${{ env.GO_VERSION }}-${{ github.job }}-
            btcwallet-${{ runner.os }}-go-${{ env.GO_VERSION }}-
            btcwallet-${{ runner.os }}-go-

      - name: setup go ${{ env.GO_VERSION }}
        uses: actions/setup-go@v5
        with:
          go-version: '${{ env.GO_VERSION }}'

      - name: add go bin to PATH
        run: echo "$(go env GOPATH)/bin" >> $GITHUB_PATH

      - name: install btcd ${{ env.BTCD_VERSION_LATEST }}
        run: go install -v github.com/btcsuite/btcd@${{ env.BTCD_VERSION_LATEST }}

      - name: check btcd version
        run: btcd --version

      # For bitcoind backend tests, btcd remains the shared miner while the
      # matrix covers both bitcoind v30 (latest) and v28 (older).
      - name: extract bitcoind from docker image (${{ matrix.bitcoind_version }})
        run: |-
          docker pull ${{ env.BITCOIND_IMAGE }}:${{ matrix.bitcoind_version }}
          CONTAINER_ID=$(docker create ${{ env.BITCOIND_IMAGE }}:${{ matrix.bitcoind_version }})

          # Different upstream image tags use slightly different install paths.
          # Try common variants in order until one succeeds.
          for BIN_PATH in \
            "/opt/bitcoin-${{ matrix.bitcoind_version }}/bin/bitcoind" \
            "/opt/bitcoin-${{ matrix.bitcoind_version }}.0/bin/bitcoind" \
            "/opt/bitcoin-${{ matrix.bitcoind_version }}.0.0/bin/bitcoind"; do
            if sudo docker cp $CONTAINER_ID:${BIN_PATH} /usr/local/bin/bitcoind; then
              break
            fi
          done

          docker rm $CONTAINER_ID
          bitcoind --version

      - name: run itest (bitcoind, kvdb)
        run: make itest chain=bitcoind db=kvdb

      - name: upload itest logs
        if: ${{ failure() }}
        uses: actions/upload-artifact@v4
        with:
          name: itest-logs-bitcoind-${{ matrix.bitcoind_version }}
          path: itest/test-logs
          retention-days: 5

  ########################
  # Complete parallel coverage uploads
  ########################
  finish:
    name: Finish coverage upload
    if: ${{ !cancelled() }}
    needs: [unit-test, itest-db]
    runs-on: ubuntu-latest
    steps:
      - name: Finish parallel Coveralls upload
        uses: coverallsapp/github-action@v2
        continue-on-error: true
        with:
          parallel-finished: true
